#include <QtCore>
#include <TreeFrogView>
#include "applicationhelper.h"

class T_VIEW_EXPORT account_formView : public TActionView
{
  Q_OBJECT
public:
  account_formView() : TActionView() { }
  QString toString();
};

QString account_formView::toString()
{
  responsebody.reserve(16455);
  responsebody += QStringLiteral("<!DOCTYPE html>\n<html>\n<head>\n	<meta charset=\"UTF-8\">\n	<html lang=\"de\"> \n\n	<title>");
  responsebody += THttpUtility::htmlEscape(controller()->name());
  responsebody += tr(" IT-IS</title>\n\n	<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0, user-scalable=yes\">\n	<link rel=\"icon\" href=\"/favicon.ico\">\n\n	<meta name=\"description\" content=\"login form for ITIS API\">\n	<meta name=\"author\" content=\"ZHENG Bote\" /> \n        \n	<script>\n		function doLocal()\n		{\n			console.log(\"this is local\");\n			\n			if (location.protocol !== 'https:') \n			{\n				let msg = \"<img class=\\\"w3-yellow\\\" src=\\\"/Icons/exclamation-square.svg\\\">&nbsp; Dies ist keine SSL-gesicherte Verbindung.\";\n				document.getElementById(\"redmsg\").innerHTML = msg;\n			}\n\n			let l_footer = document.getElementById(\"itisFooter\");\n			l_footer.message = '<a href=\"/stdsystem/license\" title=\"license\">Lizenzen</a>&nbsp;<a href=\"/stdsystem/imprint\" title=\"Imprint\">Impressum</a>';\n        \n			document.getElementById(\"formReg\").addEventListener(\"submit\", function(event) \n			{\n				event.target.checkValidity();\n				event.preventDefault();\n				event.stopPropagation();\n				sendPwdChange();\n			}, false);\n			\n			var txtPassword = document.getElementById(\"txtPassword\");\n			var txtConfirmPassword = document.getElementById(\"txtConfirmPassword\");\n			var boolForm = false;\n			txtPassword.onchange = ConfirmPassword;\n			txtConfirmPassword.onkeyup = ConfirmPassword;\n		}\n\n        function ConfirmPassword() \n        {\n            txtPassword.setCustomValidity(\"\");\n            txtConfirmPassword.setCustomValidity(\"\");\n            \n            const imgone = document.getElementById('pwdimg');\n            const imgtwo = document.getElementById('confirmimg');\n            const pwdform = document.getElementById('form1');\n            \n            if(txtPassword.validity.patternMismatch)\n            {\n				txtPassword.setCustomValidity(\"Passwort-Anforderung: Minimum 8 Zeichen mit mind. 1 Buchstaben und mind. 1 Nummer\");\n				imgone.setAttribute(\"src\", \"/Icons/nok.svg\");\n				document.getElementById(\"redmsg\").innerHTML = txtPassword.validationMessage;\n				return;\n			}\n			else\n			{\n				imgone.setAttribute(\"src\", \"/Icons/ok.svg\");\n				document.getElementById(\"redmsg\").innerHTML = \"\";\n			}\n			\n            if (txtPassword.value != txtConfirmPassword.value) \n            {\n                txtConfirmPassword.setCustomValidity(\"Passwörter nicht identisch.\");\n                imgone.setAttribute(\"src\", \"/Icons/nok.svg\");\n                imgtwo.setAttribute(\"src\", \"/Icons/nok.svg\");\n                document.getElementById(\"redmsg\").innerHTML = txtConfirmPassword.validationMessage;\n                return;\n            }\n            else\n            {\n				imgone.setAttribute(\"src\", \"/Icons/ok.svg\");\n                imgtwo.setAttribute(\"src\", \"/Icons/ok.svg\");\n                document.getElementById(\"redmsg\").innerHTML = \"\";\n			}	\n\n			boolForm = true;\n        }	\n    \n		function sendPwdChange()\n		{\n			if(! boolForm) {return;}\n			document.getElementById(\"spinner\").setAttribute(\"style\", \"display: block; margin: auto; font-size: 48px; color: Dodgerblue;\");\n\n			document.getElementById('pwdimg').setAttribute(\"src\", \"\");\n			document.getElementById('confirmimg').setAttribute(\"src\", \"\");\n			\n			var username, firstname, surname, email, company, userTimezone, groupname, groups, password, pwdChangeForce, active, newsletter;\n			var x = document.getElementById(\"formReg\");\n			var i;\n			for (i = 0; i < x.length ;i++) \n			{\n				if(x.elements[i].name != \"content\" || x.elements[i].id !== '' || x.elements[i].id !== null || x.elements[i].name !== '')\n				{\n					if(x.elements[i].name == \"username\")\n					{\n						username = x.elements[i].value;  \n					}\n					if(x.elements[i].name == \"firstname\")\n					{\n						firstname = x.elements[i].value;  \n					}\n					if(x.elements[i].name == \"surname\")\n					{\n						surname = x.elements[i].value;  \n					}\n					if(x.elements[i].name == \"email\")\n					{\n						 email = x.elements[i].value;  \n					}\n					if(x.elements[i].name == \"company\")\n					{\n						company = x.elements[i].value;  \n					}\n					if(x.elements[i].name == \"userTimezone\")\n					{\n						userTimezone = x.elements[i].value;  \n					}\n					if(x.elements[i].name == \"groupname\")\n					{\n						groupname = x.elements[i].value;  \n					}\n					if(x.elements[i].name == \"groups\")\n					{\n						groups = x.elements[i].value;  \n					}\n					if(x.elements[i].name == \"password\")\n					{\n						password = x.elements[i].value;  \n					}\n					if(x.elements[i].name == \"pwd_change_force\")\n					{\n						pwdChangeForce = x.elements[i].value;  \n					}\n					if(x.elements[i].name == \"active\")\n					{\n						active = x.elements[i].value;  \n					}\n					if(x.elements[i].name == \"news\" && x.elements[i].checked)\n					{\n						newsletter = x.elements[i].value;  \n					}\n				}\n			}\n			\n			\n			var data = new URLSearchParams([[\"username\", username], [\"firstname\", firstname], [\"surname\", surname], [\"email\", email], [\"company\", company], [\"userTimezone\", userTimezone], [\"groupname\", groupname], [\"groups\", groups], [\"password\", password], [\"pwdChangeForce\", pwdChangeForce], [\"active\", active], [\"newsletter\", newsletter]]);\n			console.log(\"data \" + data.length + \" \" + data);\n\n			//data = new URLSearchParams([[\"pwd\", txtPassword.value]]);\n			fetch(\"/account/userRegisterElectron\", { body: data, method: \"post\" })\n				.then(data => data.json())\n				.then((json) => \n				{\n					if(json[0].ERROR === \"0\")\n					{\n						let msg = '<b>Vielen Dank für Ihre Registrierung.</b></br>Sie erhalten in Kürze eine eMail mit dem Betreff \"IT-IS Account\", bitte überprüfen Sie ggf. Ihren SPAM-Ordner.'\n						document.getElementById(\"greenmsg\").innerHTML = msg;\n						doPopUp(`<p style=\"color: green\">${msg}</p>`);\n					}\n					else\n					{\n						let msg = `<b>Bei der Registrierung ist ein Fehler aufgetreten.</b></br>Bitte versuchen Sie es in Kürze erneut oder wenden Sie sich an Ihren Admin.<br/>${json[0].ERROR} ${json[0].errMsg}`;\n						document.getElementById(\"redmsg\").innerHTML = msg;\n						doPopUp(`<p style=\"color: red\">${msg}</p>`);\n					}\n					document.getElementById(\"spinner\").setAttribute(\"style\", \"display: none; margin: auto; font-size: 48px; color: Dodgerblue;\");\n				})\n				.catch((error) => \n				{\n					let msg = `<b>Bei der Registrierung ist ein Fehler aufgetreten.</b></br>Bitte versuchen Sie es in Kürze erneut oder wenden Sie sich an Ihren Admin.<br/>${error}`;\n					document.getElementById(\"redmsg\").innerHTML = msg; \n					doPopUp(`<p style=\"color: red\">${msg}</p>`); \n					document.getElementById(\"spinner\").setAttribute(\"style\", \"display: none; margin: auto; font-size: 48px; color: Dodgerblue;\");\n				});	\n			window.location.href='#body';\n		}\n\n			function doPopUp(msg)\n			{\n				const mgsTxt = document.getElementById(\"msg\");\n				mgsTxt.innerHTML = msg;		\n				const test = document.getElementById(\"pup\");\n				test.setAttribute(\"style\", \"display: block;\");\n				\n				window.location.href='#body';\n			}\n\n		function setLanguage(lang)\n		{\n			if(lang == \"0\")\n			{lang = \"de\";}\n			else{lang = \"en\";}\n			document.cookie = \"lang=\" + lang + \";\" + \";path=/\";\n			location.reload();\n		}\n	</script>\n	\n	<script type=\"module\" src=\"/js/itis_init.js\" /></script>\n\n	<link rel=\"stylesheet\" href=\"/css/w3.css\">  \n	<link rel=\"stylesheet\" href=\"/css/custom.css\">  \n\n	<style>\n	.loader {\n	  border: 16px solid #f3f3f3;\n	  border-radius: 50%;\n	  border-top: 16px solid #3498db;\n	  width: 80px;\n	  height: 80px;\n	  -webkit-animation: spin 2s linear infinite; /* Safari */\n	  animation: spin 2s linear infinite;\n	}\n\n	/* Safari */\n	@-webkit-keyframes spin {\n	  0% { -webkit-transform: rotate(0deg); }\n	  100% { -webkit-transform: rotate(360deg); }\n	}\n\n	@keyframes spin {\n	  0% { transform: rotate(0deg); }\n	  100% { transform: rotate(360deg); }\n	}\n	\n	/* input boxes */\n	.set-width { width: 33%; min-width: 250px;	border-radius: 5px;}\n	\n	</style>\n</head>\n\n<body class=\"w3-container w3-margin\" id=\"body\">\n\n  <itis-menu id=\"itisMenu\" message=\"\"></itis-menu>\n\n  <div class=\"w3-container w3-light-blue\">\n    <h2 id=\"portaltitle\">ITIS-API::Admin-Portal</h2>\n  </div>\n\n  <itis-menusub id=\"itisMenuSub\" message=\"");
  responsebody += THttpUtility::htmlEscape(controller()->name());
  responsebody += QStringLiteral("\"></itis-menusub>\n\n<h3 id=\"pagetitle\"><page-title message=\"\">Admin Login</page-title></h3>\n<div id=\"pagedesc\"><page-desc message=\"\"></page-desc></div>\n\n<p style=\"color: red\"><span id=\"redmsg\">");
  techoex(red_msg);
  responsebody += QStringLiteral("</span>");
  tehex(error);
  responsebody += QStringLiteral("</p><p style=\"color: green\"><span id=\"greenmsg\">");
  techoex(green_msg);
  responsebody += QStringLiteral("</span>");
  tehex(notice);
  responsebody += QStringLiteral("</p>\n\n<cookie-alert id=\"cookieAlert\" message='Auch diese Webseite mag Cookies...<small><a href=\"/stdsystem/imprint#cookies\" title=\"Impressum\" style=\"color:rgb(255, 255, 255);\">Details siehe: Impressum</a></small>'></cookie-alert>\n  \n<div id=\"pup\" style=\"display: none;\" class=\"w3-modal\">\n    <div class=\"w3-modal-content\">\n      <div class=\"w3-container\">\n        <span onclick=\"document.getElementById('pup').style.display='none'\" class=\"w3-button w3-display-topright\">&times;</span>\n        <span id=\"msg\"></span>\n      </div>\n    </div>\n  </div>\n</div>\n\n<span id=\"spinner\" class=\"loader\" style=\"display: none; margin: auto; color: Dodgerblue;\" align=\"center\"></span>\n\n<main>\n\n<section>\n	\n<div class=\"w3-container\">\n	\n  <div class=\"w3-row\">\n    <a style=\"background: none;\" href=\"javascript:void(0)\" onclick=\"openTab(event, 'loginform');\">\n      <div class=\"w3-third tablink w3-bottombar w3-hover-light-grey w3-padding w3-border-light-blue\">Login</div>\n    </a>\n    <a style=\"background: none;\" href=\"javascript:void(0)\" onclick=\"openTab(event, 'registration');\">\n      <div class=\"w3-third tablink w3-bottombar w3-hover-light-grey w3-padding\">Registration</div>\n    </a>\n  </div>\n\n  <div id=\"loginform\" class=\"w3-container tabby\" style=\"display:block\">\n    <h3>Anmeldung</h3>\n    <p>\n		<form action=\"/account/login\" method=\"post\">\n\n				<label class=\"w3-opacity\" for=\"username\">Login Name <small>(eMail-Adresse)</small>:<br /><input type=\"email\" id=\"username\" class=\"w3-input set-width\" name=\"username\" value=\"\" required /></label>\n				<label class=\"w3-opacity\" for=\"password\">Passwort:<br><input type=\"password\" id=\"password\" class=\"w3-input set-width\" name=\"password\" value=\"\" required /> </label>\n				<p><input type=\"submit\" value=\"login &raquo;\" title=\"submit\" />&nbsp;<popup-info data-text=\"die &Uuml;bertragung sollte &uuml;ber eine gesicherte SSL-Verbindung erfolgen.\"></popup-info></p>\n\n		</form>\n    </p>\n  </div>\n\n  <div id=\"registration\" class=\"w3-container tabby\" style=\"display:none\">\n    <h3>Registrierung</h3>\n    <p>\n		 <form id=\"formReg\">\n			<div class=\"w3-row-padding\">\n			  <div class=\"w3-half\">\n				<label><span class=\"w3-opacity\">firstname / Vorname</span><br /><input class=\"w3-input\" name=\"firstname\" pattern=\"[A-Za-z]{2,128}\" placeholder=\"Arthur\" value=\"\" required /></label>\n			  </div>\n			  <div class=\"w3-half\">\n				<label><span class=\"w3-opacity\">surname / Familienname</span><br /><input class=\"w3-input\" name=\"surname\" pattern=\"[A-Za-z]{2,128}\" placeholder=\"Dent\" value=\"\" required /></label>\n			  </div>\n			  <div class=\"w3-half\">\n				<label><span class=\"w3-opacity\">email</span>&nbsp;<popup-info data-text=\"an diese eMail-Adresse wird die Registrierungs-Best&auml;tigung versendet.\"></popup-info><br /><input class=\"w3-input\" name=\"email\" type=\"email\" value=\"\" required /></label>\n			  </div>\n			  <div class=\"w3-half\">\n				<label><span class=\"w3-opacity\">login name / Anmelde-Name</span>&nbsp;<popup-info data-text=\"mit dieser eMail-Adresse werden Sie sich sp&auml;ter am System anmelden.\"></popup-info><br /><input class=\"w3-input\" type=\"email\" name=\"username\" value=\"\" required /></label>\n			  </div>\n			 <div class=\"w3-half\">\n				<label><span class=\"w3-opacity\">company / Firma</span>&nbsp;<popup-info data-text=\"Unternehmen f&uuml;r das Sie t&auml;tig sind.\"></popup-info><br /><input class=\"w3-input\" name=\"company\" value=\"\" placeholder=\"best Company Ltd.\" required /></label>\n			  </div>\n			  <div class=\"w3-half\">\n				<label><span class=\"w3-opacity\">user timezone / Zeitzone</span>&nbsp;<popup-info data-text=\"die Zeitzone in der Sie sich &uuml;berwiegend aufhalten.\"></popup-info><br /><input class=\"w3-input\" name=\"userTimezone\" value=\"Europe/Berlin\" /></label>\n			  </div>\n			  <div class=\"w3-half\">\n				<input class=\"w3-input\" name=\"groupname\" type=\"hidden\" pattern=\"[A-Za-z]{3,128}\" value=\"{ALL}\" readonly />\n			   </div>\n			   <div class=\"w3-half\">\n				<input class=\"w3-input\" name=\"groups\" type=\"hidden\" pattern=\"[A-Za-z]{3,128}\" value=\"{ALL}\" readonly />\n			  </div>\n			  <p><br></p>\n			  <div class=\"w3-half\">\n				<label for=\"txtPassword\"><span class=\"w3-opacity\">Password</span>&nbsp;<popup-info data-text=\"das Passwort wird SHA2-256 verschl&uuml;sselt.\"></popup-info>&nbsp;<img src=\"\" id=\"pwdimg\" width=\"10px\" /></label><br/>\n				<input name=\"password\" type=\"password\" id=\"txtPassword\" title=\"Password must contain: Minimum 8 characters and at least 1 Alphabet and 1 Number\" class=\"w3-input\" required pattern=\"^(?=.*[A-Za-z])(?=.*\\d)[A-Za-z\\d]{8,}$\" />\n			   <div>\n			   <div class=\"w3-half\">\n					<label for=\"txtConfirmPassword\"><span class=\"w3-opacity\">Confirm Password</span>&nbsp;<img src=\"\" id=\"confirmimg\" width=\"10px\" /></label><br>\n					<input name=\"txtConfirmPassword\" type=\"password\" id=\"txtConfirmPassword\" class=\"w3-input\" />\n				</div>\n		   </div>\n\n			  <p><br>&nbsp;</p><p>\n					  <p><b><u>Newsletter:</u></b>&nbsp;<popup-info data-text=\"Benachrichtigungen &uuml;ber Produkt-&Auml;nderungen sowie Aktualisierungen der Vorgaben.\"></popup-info></p>\n					  <input type=\"radio\" id=\"news_de\" name=\"news\" value=\"de\">\n					  <label for=\"news_de\">deutsch</label><br>\n					  <input type=\"radio\" id=\"news_en\" name=\"news\" value=\"en\" checked>\n					  <label for=\"news_en\">englisch</label><br>\n					  <input type=\"radio\" id=\"news_no\" name=\"news\" value=\"no\">\n					  <label for=\"news_no\">keinen</label>\n					</p>\n			  <p>\n				<label>Active&nbsp;<popup-info data-text=\"das Benutzer-Konto wird w&auml;hrend des Registrierungs-Prozesses freigeschaltet.\"></popup-info><br /><input type=\"text\" class=\"w3-input set-width\" title=\"will be activated during confirmation process.\" type=\"number\" pattern=\"[0-1]{1}\" name=\"active\" value=\"0\" readonly /></label>\n			  </p>\n			  <p>\n				<p><input type=\"submit\" id=\"submitpwd\" value=\"absenden &raquo;\" title=\"submit\" onclick=\"sendPwdChange\" />&nbsp;<popup-info data-text=\"die &Uuml;bertragung sollte &uuml;ber eine gesicherte SSL-Verbindung erfolgen.\"></popup-info></p>\n			  </p>\n		  \n	</form>\n    </p> \n  </div>\n\n</div>\n\n<script>\n	function openTab(evt, tabName) \n	{\n		document.getElementById(\"redmsg\").innerHTML = \"\";\n		document.getElementById(\"greenmsg\").innerHTML = \"\";\n\n		var i, x, tablinks;\n		x = document.getElementsByClassName(\"tabby\");\n		for (i = 0; i < x.length; i++) \n		{\n			x[i].style.display = \"none\";\n		}\n		tablinks = document.getElementsByClassName(\"tablink\");\n		for (i = 0; i < x.length; i++) \n		{\n			tablinks[i].className = tablinks[i].className.replace(\" w3-border-light-blue\", \"\");\n		}\n		document.getElementById(tabName).style.display = \"block\";\n		evt.currentTarget.firstElementChild.className += \" w3-border-light-blue\";\n	}\n</script>\n\n</section>\n\n</main>\n<itis-footer id=\"itisFooter\" message=\"\"></itis-footer>\n</body>\n</html>\n");

  return responsebody;
}

T_DEFINE_VIEW(account_formView)

#include "account_formView.moc"
