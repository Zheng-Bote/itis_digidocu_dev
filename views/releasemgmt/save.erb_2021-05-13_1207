<!DOCTYPE html>
<%#include "releasemgmt.h" %>
<% tfetch(QVariantMap, releaseMgmt); %>
<%#include "lenkinfo.h" %>
<% tfetch(QVariantMap, lenkinfo); %>
<html>
<head>
  <meta charset="UTF-8">
  <html lang="de">

  <title><%= controller()->name() + ": " + controller()->activeAction() %></title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="alternate icon" href="/favicon.ico">
  <link rel="mask-icon" href="/favicon.svg" color="#b2b2b2">

  <script>
    function doLocal()
    {
        console.log("this is local");

        let l_footer = document.getElementById("itisFooter");
        l_footer.message = '<a href="/stdsystem/license" title="licenses">Lizenzen</a>&nbsp;<a href="/stdsystem/imprint" title="Imprint">Impressum</a>';

        //let l_menu = document.getElementById("itisMenu"); 
        //l_menu.message = "<%= controller()->name() %>";
        
        let relstatusprogress = "<%= lenkinfo["lenkStatus"] %>";
        if(relstatusprogress === 'pre-released')
        {
			document.getElementById('relstatusprogress').style.width = "75%";
			document.getElementById('relstatusprogress').innerHTML = 'pre-release review 75%';
		}
		
		console.log("Title: <%= lenkinfo["specTitle"] %>");
		
		convertUTCDateToLocalDate('relrequestDate', "<%= releaseMgmt["relrequestDate"] %>");
		convertUTCDateToLocalDate('relcreatorDecisdate', "<%= releaseMgmt["relcreatorDecisdate"] %>");
		convertUTCDateToLocalDate('relinspectDecisdate', "<%= releaseMgmt["relinspectDecisdate"] %>");
		convertUTCDateToLocalDate('relapprovDecisdate', "<%= releaseMgmt["relapprovDecisdate"] %>");
		convertUTCDateToLocalDate('ciDate', "<%= releaseMgmt["ciDate"] %>");
		convertUTCDateToLocalDate('cdDate', "<%= releaseMgmt["cdDate"] %>");
		convertUTCDateToLocalDate('cddDate', "<%= releaseMgmt["cddDate"] %>");
    }

	function setLanguage(lang)
	{
		if(lang == "0")
		{lang = "de";}
		else{lang = "en";}
		document.cookie = "lang=" + lang + ";" + ";path=/";
		location.reload();
	}

	function convertUTCDateToLocalDate(id, datetime) 
	{
		if(! datetime)
		{
			return;
		}
		var date = new Date(datetime);
		var newDate = new Date(date.getTime()+date.getTimezoneOffset()*60*1000);

		var offset = date.getTimezoneOffset() / 60;
		var hours = date.getHours();

		newDate.setHours(hours - offset);
		
		var mm = newDate.getMonth() + 1;
		var dd = newDate.getDate();
		var yy = newDate.getFullYear();
		var hh = newDate.getHours();
		var m = newDate.getMinutes();

		if(mm < 10)
		{
			mm = "0" + mm;
		}
		if(dd < 10)
		{
			dd = "0" + dd;
		}

		let datestr = yy + "-" + mm + "-" + dd;
		
		if(id) {
			document.getElementById(id).value = datestr;
		}
		else {
			return datestr;
		}   
	}
  </script>

  <script type="module" src="/js/itis_init.js" /></script>
	<!-- dev -->
	<script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
	<!-- prod <script src="https://cdn.jsdelivr.net/npm/vue@2"></script> -->
  
  <link rel="stylesheet" href="/css/w3.css">  
  <link rel="stylesheet" href="/css/custom.css">  

	<style>
		.set-width { width: 33%; min-width: 100px; border-radius: 5px;}
		.w3-half {	margin-bottom: 1rem;	}
	</style>
</head>

<body class="w3-container w3-margin" id="body">

  <itis-menu id="itisMenu" message=""></itis-menu>

  <div class="w3-container w3-light-blue">
    <h2 id="portaltitle">ITIS-API::Admin-Portal</h2>
  </div>

  <itis-menusub id="itisMenuSub" message="<%= controller()->name() %>"></itis-menusub>

<h3 id="pagetitle"><page-title message=""><%= controller()->name() + ": " + controller()->activeAction() %></page-title></h3>
<div id="pagedesc"><page-desc message=""></page-desc></div>

<span style="color: red">
	<span  id="redmsg"><%==$ red_msg %></span>&nbsp;<span><%=$ error %></span>
</span>
<span style="color: green">
	<span id="greenmsg"><%==$ green_msg %></span>&nbsp;<span><%=$ notice %></span>
</span>

<div class="w3-container">

<div class="w3-bar" style="border-radius: 0.5em 0.5em 0px 0px; background: #F1F3F4;">
	<button class="w3-bar-item w3-button tablink w3-grey" onclick="openCity(event,'London')">1. Release Status</button>
    <button class="w3-bar-item w3-button tablink" onclick="openCity(event,'Paris')">2. Lenkungsinfo</button>
    <button class="w3-bar-item w3-button tablink" onclick="openCity(event,'Tokyo')">3. show Release</button>
</div>
<main style="border-radius: 0px 0px 0.5em 0.5em;">
<div id="pagecontent"><page-content message=""></page-content></div>


	
<div id="London" class="w3-container w3-border city">
	
<section>
	<h3>Release Status-Anzeige</h3>
	<div class="w3-light-grey">
		<div id="relstatusprogress" class="w3-container w3-green w3-center" style="width:50%">pre-released 50%</div>
		<small>draft: 25% - pre-release: 50% - pre-release review: 75% - released: 100%</small>
	</div><br>

<%== formTag(urla("save", releaseMgmt["id"]), Tf::Post) %>
	<div class="w3-row-padding">
	  <p>
		<label class="w3-opacity">ID<br /><input class="w3-input w3-border w3-round set-width" type="text" name="releaseMgmt[id]" value="<%= releaseMgmt["id"] %>" readonly="readonly" /></label>
	  </p>
	  <div class="w3-half">
		<label class="w3-opacity">Obj Sname<br /><input class="w3-input w3-border w3-round" name="releaseMgmt[objSname]" value="<%= releaseMgmt["objSname"] %>" readonly /></label>
	  </div>
	  <div class="w3-half">
		<label class="w3-opacity">Spec Version<br /><input class="w3-input w3-border w3-round" name="releaseMgmt[specVersion]" value="<%= releaseMgmt["specVersion"] %>" readonly /></label>
	  </div>
	  <div class="w3-half">
		<label class="w3-opacity">Ac Classes<br /><input class="w3-input w3-border w3-round" name="releaseMgmt[acClasses]" value="<%= releaseMgmt["acClasses"] %>" readonly /></label>
	  </div>
	  <div class="w3-half">
		<label class="w3-opacity">Pc Classes<br /><input class="w3-input w3-border w3-round" name="releaseMgmt[pcClasses]" value="<%= releaseMgmt["pcClasses"] %>" readonly /></label>
	  </div>
	  <div class="w3-half">
		<label class="w3-opacity">Cat Class<br /><input class="w3-input w3-border w3-round" name="releaseMgmt[catClass]" value="<%= releaseMgmt["catClass"] %>" readonly /></label>
	  </div>
	  <div class="w3-half">
		<label class="w3-opacity">Country<br /><input class="w3-input w3-border w3-round" name="releaseMgmt[country]" value="<%= releaseMgmt["country"] %>" readonly /></label>
	  </div>
	  <div class="w3-half">
		<label class="w3-opacity">Lang<br /><input class="w3-input w3-border w3-round" name="releaseMgmt[lang]" value="<%= releaseMgmt["lang"] %>" readonly /></label>
	  </div>
	  <div class="w3-half">
		<label class="w3-opacity">Doc Type<br /><input class="w3-input w3-border w3-round" name="releaseMgmt[docType]" value="<%= releaseMgmt["docType"] %>" readonly /></label>
	  </div>
	  <div class="w3-half">
		<label class="w3-opacity">Rel Requester<br /><input class="w3-input w3-border w3-round" name="releaseMgmt[relRequester]" value="<%= releaseMgmt["relRequester"] %>" readonly /></label>
	  </div>
	  <div class="w3-half">
		<label class="w3-opacity">Relrequest Date<br /><input class="w3-input w3-border w3-round" name="releaseMgmt[relrequestDate]" id="relrequestDate" value="" readonly /></label>
	  </div>
	  <div class="w3-half">
		<label class="w3-opacity">Rel Creator<br /><input class="w3-input w3-border w3-round" name="releaseMgmt[relCreator]" value="<%= releaseMgmt["relCreator"] %>" readonly /></label>
	  </div>
	  <div class="w3-half">
		<label class="w3-opacity">Relcreator Decisdate<br /><input class="w3-input w3-border w3-round" name="releaseMgmt[relcreatorDecisdate]" id="relcreatorDecisdate" value="" readonly /></label>
	  </div>
	  <div class="w3-half">
		<label class="w3-opacity">Rel Inspector<br /><input class="w3-input w3-border w3-round" name="releaseMgmt[relInspector]" value="<%= releaseMgmt["relInspector"] %>" readonly /></label>
	  </div>
	  <div class="w3-half">
		<label class="w3-opacity">Relinspect Decisdate<br /><input class="w3-input w3-border w3-round" name="releaseMgmt[relinspectDecisdate]" id="relinspectDecisdate" value="" readonly /></label>
	  </div>
	  <div class="w3-half">
		<label class="w3-opacity">Rel Approver<br /><input class="w3-input w3-border w3-round" name="releaseMgmt[relApprover]" value="<%= releaseMgmt["relApprover"] %>" readonly /></label>
	  </div>
	  <div class="w3-half">
		<label class="w3-opacity">Relapprov Decisdate<br /><input class="w3-input w3-border w3-round" name="releaseMgmt[relapprovDecisdate]" id="relapprovDecisdate" value="" readonly /></label>
	  </div>
	  <div class="w3-third">
		<label class="w3-opacity">CI Date<br /><input class="w3-input w3-border w3-round" name="releaseMgmt[ciDate]" id="ciDate" value="" readonly /></label>
	  </div>
	  <div class="w3-third">
		<label class="w3-opacity">CD Date<br /><input class="w3-input w3-border w3-round" name="releaseMgmt[cdDate]" id="cdDate" value="" readonly /></label>
	  </div>
	  <div class="w3-third">
		<label class="w3-opacity">CDD Date<br /><input class="w3-input w3-border w3-round" name="releaseMgmt[cddDate]" id="cddDate" value="" readonly /></label>
	  </div>
	  <!--
	  <p>&nbsp;</p>
	  <p>
		<input type="submit" value="speichern &raquo;"/>
	  </p>
  -->
	</div>
</form>
</section>

</div>

<div id="Paris" class="w3-container w3-border city" style="display:none">

<article> 
	<h3>Eingabe Lenkungsinformation zum aktuellen Release</h3>
<!-- <form action="/lenkinfo/create" method="post"> -->
<div id="app">
  {{ message }}
     <div v-if="totalVuePackages" class="content">
		 <section>
		<table style="width:100%;">
			<tbody>
				<tr>
					<td style="background-color:#D9D9D9;border-bottom:1.0pt solid windowtext;border-left:1.0pt solid windowtext;border-right:1.0pt solid windowtext;border-top:1.0pt solid windowtext;padding:2.85pt;vertical-align:top;width:46.55pt;" rowspan="3">
						<p style="text-align:center;"><strong>BMW Group</strong></p>
					</td>
					<td style="border-bottom:1.0pt solid windowtext;border-left:1.0pt none windowtext;border-right:1.0pt solid windowtext;border-top:1.0pt solid windowtext;padding:2.85pt;vertical-align:top;" colspan="2"><strong>Unterlagenklasse:</strong> 3.2
					</td>
					<td style="border-bottom:1.0pt solid windowtext;border-left:1.0pt none windowtext;border-right:1.0pt solid windowtext;border-top:1.0pt solid windowtext;padding:2.85pt;vertical-align:top;" colspan="3"><strong>Nr.:</strong> 01
					</td>
				</tr>
				<tr>
					<td style="border-bottom:1.0pt solid windowtext;border-left:none;border-right:1.0pt solid windowtext;border-top:none;padding:2.85pt;vertical-align:top;" colspan="2"><strong>Gültigkeitsbereich:</strong> BMW Group
					</td>
					<td style="border-bottom:1.0pt solid windowtext;border-left:none;border-right:1.0pt solid windowtext;border-top:none;padding:2.85pt;vertical-align:top;" colspan="3"><strong>Version:</strong> {{ lenk_version }}</span>
					</td>
				</tr>
				<tr>
					<td style="border-bottom:1.0pt solid windowtext;border-left:none;border-right:1.0pt solid windowtext;border-top:none;height:1.0pt;padding:2.85pt;vertical-align:top;" colspan="2"><p style="margin-left:0px;">Vorgabedokument der BMW Group</p><p>für die passive IT Infrastruktur</p><p><strong>{{ obj_sname }}<br>{{ lenk_title }}</strong></p><p>&nbsp;</p><p>&nbsp;</p></td><td style="border-bottom:1.0pt solid windowtext;border-left:none;border-right:1.0pt solid windowtext;border-top:none;height:1.0pt;padding:2.85pt;vertical-align:top;" colspan="3"><p><strong>Status:</strong></p><p>{{ status }}</p>
					</td>
				</tr>
				<tr>
					<td style="background-color:#D9D9D9;border-bottom:1.0pt solid windowtext;border-left:1.0pt solid windowtext;border-right:1.0pt solid windowtext;border-top:1.0pt none windowtext;height:1.0pt;padding:2.85pt;vertical-align:top;">&nbsp;
					</td>
					<td style="border-bottom:1.0pt solid windowtext;border-left:none;border-right:1.0pt solid windowtext;border-top:none;height:1.0pt;padding:2.85pt;vertical-align:top;" colspan="2"><p style="text-align:right;"><strong>Beteiligte Personen/Fachstellen/Gremien:&nbsp;</strong></p>
					</td>
					<td style="border-bottom:1.0pt solid windowtext;border-left:none;border-right:1.0pt solid windowtext;border-top:none;height:1.0pt;padding:2.85pt;vertical-align:top;" colspan="3">{{ lenk_departments }}
					</td>
				</tr>
			</tbody>
		</table>
		<br>
		<table style="width:100%;">
			<thead>
				<tr>
					<th colspan="5" style="text-align: left;">Änderungshistorie</th>
				</tr>
				<tr>
					<th style="min-width:30px;">Version</th>
					<th>Inhalt</th>
					<th style="min-width:100px;">Ersteller<br>Kurzzeichen<br>Datum</th>
					<th style="min-width:100px;">Prüfer<br>Kurzzeichen<br>Datum</th>
					<th style="min-width:100px;">Freigeber<br>Kurzzeichen<br>Datum</th>
				</tr>
			</thead>
			<tr v-for="item in totalVuePackages" :key="item.obj_sname">
				<td>{{ item.lenk_version }}</td>
				<td>{{ item.lenk_content }}</td>
				<td>{{ item.lenk_creator }}<br>{{ item.lenk_creator_date }}</td>
				<td>{{ item.lenk_auditor }}<br>{{ item.lenk_auditor_date }}</td>
				<td>{{ item.lenk_approver }}<br>{{ item.lenk_approver_date }}</td>
			</tr>
			<tr v-if="lenk_content" @>
				<td>{{ lenk_version }}</td>
				<td>{{ lenk_content }}</td>
				<td>{{ lenk_creator }}<br>{{ lenk_creator_date }}</td>
				<td>{{ lenk_auditor }}<br>-/-</td>
				<td>{{ lenk_approver }}<br>-/-</td>
			</tr>
		</table>
		</section>
    </div>
    
    <form @submit.prevent="handleSubmit">
		<input type="text" v-model="obj_sname" name="obj_sname"/>
		<input type="text" v-model="status" name="lang"/>
    </form>
    
    <section> 
		<h3>Eingabe Lenkungsinformation zum aktuellen Release</h3>
		<form action="/lenkinfo/create" method="post">
		<div class="w3-row-padding">
		  <div class="w3-half">
			<label class="w3-opacity">Spec Obj<br /><input class="w3-input w3-border w3-round set-width" name="lenkinfo[specObj]" v-model="obj_sname" value="" readonly /></label>
		  </div>
		  <div class="w3-half">
			<label class="w3-opacity">Spec Title<br /><input class="w3-input w3-border w3-round" name="lenkinfo[specTitle]" v-model="lenk_title" value="" readonly /></label>
		  </div>
		  <div class="w3-half">
			<label class="w3-opacity">AC Class <small>(1-4)</small><br /><input class="w3-input w3-border w3-round" name="lenkinfo[acClass]" v-model="ac_class" value="" readonly /></label>
		  </div>
		  <div class="w3-half">
			<label class="w3-opacity">PC Class <small>(1-4)</small><br /><input class="w3-input w3-border w3-round" name="lenkinfo[pcClass]" v-model="pc_class" value="" readonly /></label>
		  </div>
		  <div class="w3-half">
			<label class="w3-opacity">Country <small>(WW | DE | EN ...)</small><br /><input class="w3-input w3-border w3-round" name="lenkinfo[country]" v-model="country" value="" readonly /></label>
		  </div>
		  <div class="w3-half">
			<label class="w3-opacity">Lang <small>(de_DE | en_GB)</small><br /><input class="w3-input w3-border w3-round" name="lenkinfo[lang]" v-model="lang" v-model="lang" value="" readonly /></label>
		  </div>
		  <div class="w3-half">
			<label class="w3-opacity">Lenk Version <small>(00.00.00)</small><br /><input class="w3-input w3-border w3-round" name="lenkinfo[lenkVersion]" v-model="lenk_version" value="" /></label>
		  </div>
		  
			<label class="w3-opacity">Lenk Status <small>(draft | pre-released | pre-released review | released | expired)</small><br />
			<select v-model="status">
			  <option disabled value="">Please select one</option>
			  <option>pre-released</option>
			  <option>pre-released (review)</option>
			  <option disabled value="">released</option>
			  <option disabled value="">expired</option>
			</select>
			<!-- <input class="w3-input w3-border w3-round" name="lenkinfo[lenkStatus]" v-model="status" value="" /> -->
			</label>
		  
<div class="w3-half"><br></div>
		  <div class="w3-half">
			<label class="w3-opacity">Lenk Valid Startdate <small>(dd.mm.yyyy)</small><br /><input type="date" class="w3-input w3-border w3-round" name="lenkinfo[lenkValidStartdate]" value="" /></label>
		  </div>
		  <div class="w3-half">
			<label class="w3-opacity">Lenk Departments <small>(FG-84*, FG-85*, FG-86*, ...)</small><br /><input class="w3-input w3-border w3-round" name="lenkinfo[lenkDepartments]" v-model="lenk_departments" value="" /></label>
		  </div>
		  <p>
			<label class="w3-opacity">Lenk Content<br /><input class="w3-input w3-border w3-round" name="lenkinfo[lenkContent]" v-model="lenk_content" value="" /></label>
		  </p>
		  <div class="w3-half">
			<label class="w3-opacity">Lenk Creator <small>(Name, Department)</small><br /><input class="w3-input w3-border w3-round" name="lenkinfo[lenkCreator]" v-model="lenk_creator" value="" /></label>
		  </div>
		  <div class="w3-half">
			<label class="w3-opacity">Lenk Creator Date <small>(dd.mm.yyyy)</small><br /><input type="date" class="w3-input w3-border w3-round" name="lenkinfo[lenkCreatorDate]" id="lenkCreatorDate" v-model="lenk_creator_date" value="" /></label>
		  </div>
		  <div class="w3-half">
			<label class="w3-opacity">Lenk Auditor <small>(Name, Department)</small><br /><input class="w3-input w3-border w3-round" name="lenkinfo[lenkAuditor]" v-model="lenk_auditor" value="" /></label>
		  </div>
		  <div class="w3-half">
			<label class="w3-opacity">Lenk Auditor Date <small>(dd.mm.yyyy)</small><br /><input type="date" class="w3-input w3-border w3-round" name="lenkinfo[lenkAuditorDate]" value="" /></label>
		  </div>
		  <div class="w3-half">
			<label class="w3-opacity">Lenk Approver <small>(Name, Department)</small><br /><input class="w3-input w3-border w3-round" name="lenkinfo[lenkApprover]" v-model="lenk_approver" value="" /></label>
		  </div>
		  <div class="w3-half">
			<label class="w3-opacity">Lenk Approver Date <small>(dd.mm.yyyy)</small><br /><input type="date" class="w3-input w3-border w3-round" name="lenkinfo[lenkApproverDate]" value="" /></label>
		  </div>
		  <p>&nbsp;</p>
		  <p>
			<input type="submit" value="Create &raquo;" />
		  </p>
		</div>
		</form>

	</section>
</div>

</article>

</div>

<div id="Tokyo" class="w3-container w3-border city" style="display:none">
<section> 
	<h3>show Release</h3>
	<p>hier wird dann das ausgewählte Release gemäß Status angezeigt</p>
	
	<button id="prereleaseBtn" class="w3-btn w3-light-grey" onClick='window.open("/releasemgmt/show/" + <%= releaseMgmt["id"] %>);'> &uarr; show Pre-Release</button>
	
</section>
</div>

<br>
<a href="javascript:window.close();" style="border-radius: 0px 0px 0px 0.5em;" class="w3-btn w3-light-grey"><img src="/Icons/justify.svg">&nbsp;zur&uuml;ck</a>

</div>

</main>

	<script>
      function openCity(evt, cityName) {
        var i, x, tablinks;
        x = document.getElementsByClassName("city");
        for (i = 0; i < x.length; i++) {
          x[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("tablink");
        for (i = 0; i < x.length; i++) {
          tablinks[i].className = tablinks[i].className.replace(" w3-grey", "");
        }
        document.getElementById(cityName).style.display = "block";
        evt.currentTarget.className += " w3-grey";
      }
  
    </script>


<script>
	
var app = new Vue({
  el: '#app',
  data (){
	  return {
    message: 'Hello Vue!',
    totalVuePackages: null,
    submitted: false,
    obj_sname: "<%= releaseMgmt["objSname"] %>",
    country: "<%= releaseMgmt["country"] %>",
    lang: "<%= releaseMgmt["lang"] %>",
    ac_class: "<%= releaseMgmt["acClasses"] %>",
    pc_class: "<%= releaseMgmt["pcClasses"] %>",
    lenk_creator_date: null,
    lenkinfo_version: null,
    lenk_departments: null,
    status: 'pre-released',
    lenk_status: "<%= lenkinfo["lenkStatus"] %>",
    lenk_title: null,
    lenk_version: null,
    lenk_content: null,
    lenk_creator: null,
    lenk_creator_date: null,
    lenk_auditor: null,
    lenk_approver: null,
    lenk_departments: null
}
  },
  created () {
    // fetch the data when the view is created and the data is
    // already being observed
    this.getData()
  },
	/*watch: {
		lenk_creator_date: function (val, oldVal) {
			console.log('new: %s, old: %s', val, oldVal);
		}
	}, */
  methods: {
	async getData() {
	  // GET request using fetch with async/await
	  let pdata = new URLSearchParams([["spec_obj", "Annex D"], ["ac_class", "1"], ["pc_class", "1"], ["country", "WW"], ["lang", "de_DE"]]);
	  const response = await fetch("/lenkinfo/getJson",
	  {
		body: pdata,
		method: "post"
	  });
	  const data = await response.json();
	  let dlength = data.length;
	  this.lenk_version = data[dlength -1].lenk_version;
	  this.lenk_departments = data[dlength -1].lenk_departments;
	  this.lenk_title = data[dlength -1].spec_title;
	  this.lenk_creator = data[dlength -1].lenk_creator
	  this.lenk_auditor = data[dlength -1].lenk_auditor
      this.lenk_approver = data[dlength -1].lenk_approver
	  this.totalVuePackages = data;
	},
	handleSubmit (e) {
		this.submitted = true;
		const { obj_sname, lang } = this;

		// stop here if form is invalid
		if (!(username && password)) {
			return;
		}
	}
  }
})

app.lenk_creator_date = convertUTCDateToLocalDate(null, "<%= releaseMgmt["relcreatorDecisdate"] %>");
</script>

<itis-footer id="itisFooter" message=""></itis-footer>
  
</body>
</html>
